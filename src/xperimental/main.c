#include <riscv_vector.h>
// #include <stdio.h>
#include <stdint.h>

#define OPCODE_DS_SHIFT_VAL 7
#define OPCODE_RS1_SHIFT_VAL 15
#define OPCODE_RS2_SHIFT_VAL 20

#define CUSTOM0 0x0b
#define CUSTOM1 0x2b

#define FINISHER_BASE 0x3fffb000

// scalar add

#define _XSTR(x) #x
//  #define ADD_KNOP_p(ds, s1, s2, rs1)   asm   (".word(((" _XSTR(s1) ") << " _XSTR(OPCODE_S1_SHIFT) ") | ((" _XSTR(s2) ") <<" _XSTR(OPCODE_S2_SHIFT) ") | (((((\"%0\"==\"t0\") &5) |((\"%0\"==\"t1\") &6) |((\"%0\"==\"t2\") &7) |((\"%0\"==\"s0\") &8) |((\"%0\"==\"s1\") &9) |((\"%0\"==\"a0\") &10)|((\"%0\"==\"a1\") &11)|((\"%0\"==\"a2\") &12)|((\"%0\"==\"a3\") &13)|((\"%0\"==\"a4\") &14)|((\"%0\"==\"a5\") &15)|((\"%0\"==\"a6\") &16)|((\"%0\"==\"a7\") &17)|((\"%0\"==\"s2\") &18)|((\"%0\"==\"s3\") &19)|((\"%0\"==\"s4\") &20)|((\"%0\"==\"s5\") &21)|((\"%0\"==\"s6\") &22)|((\"%0\"==\"s7\") &23)|((\"%0\"==\"s8\") &24)|((\"%0\"==\"s9\") &25)|((\"%0\"==\"s10\")&26)|((\"%0\"==\"s11\")&27)|((\"%0\"==\"t3\") &28)|((\"%0\"==\"t4\") &29)|((\"%0\"==\"t5\") &30)|((\"%0\"==\"t6\") &31))) << " _XSTR(OPCODE_RS1_SHIFT) ") | (1  <<" _XSTR(OPCODE_OP_SHIFT) ") | ((" _XSTR(ds) ") <<" _XSTR(OPCODE_DS_SHIFT) ") | (0x0b))" : : "r" (rs1))
// #define PERIAADD(rd, rs1, rs2) __asm__ volatile (".word ((" \
//     ((((\"%0\"==\"t0\") &5)\
//          |((\"%0\"==\"t1\") &6)\
//          |((\"%0\"==\"t2\") &7)\
//          |((\"%0\"==\"s0\") &8)\
//          |((\"%0\"==\"s1\") &9)\
//          |((\"%0\"==\"a0\") &10)\
//          |((\"%0\"==\"a1\") &11)\
//          |((\"%0\"==\"a2\") &12)\
//          |((\"%0\"==\"a3\") &13)\
//          |((\"%0\"==\"a4\") &14)\
//          |((\"%0\"==\"a5\") &15)\
//          |((\"%0\"==\"a6\") &16)\
//          |((\"%0\"==\"a7\") &17)\
//          |((\"%0\"==\"s2\") &18)\
//          |((\"%0\"==\"s3\") &19)\
//          |((\"%0\"==\"s4\") &20)\
//          |((\"%0\"==\"s5\") &21)\
//          |((\"%0\"==\"s6\") &22)\
//          |((\"%0\"==\"s7\") &23)\
//          |((\"%0\"==\"s8\") &24)\
//          |((\"%0\"==\"s9\") &25)\
//          |((\"%0\"==\"s10\")&26)\
//          |((\"%0\"==\"s11\")&27)\
//          |((\"%0\"==\"t3\") &28)\
//          |((\"%0\"==\"t4\") &29)\
//          |((\"%0\"==\"t5\") &30)\
//          |((\"%0\"==\"t6\") &31))) << " _XSTR(OPCODE_RS1_SHIFT_VAL) ")\
//     ") | (" \
//     ((((\"%1\"==\"t0\") &5)\
//          |((\"%1\"==\"t1\") &6)\
//          |((\"%1\"==\"t2\") &7)\
//          |((\"%1\"==\"s0\") &8)\
//          |((\"%1\"==\"s1\") &9)\
//          |((\"%1\"==\"a0\") &10)\
//          |((\"%1\"==\"a1\") &11)\
//          |((\"%1\"==\"a2\") &12)\
//          |((\"%1\"==\"a3\") &13)\
//          |((\"%1\"==\"a4\") &14)\
//          |((\"%1\"==\"a5\") &15)\
//          |((\"%1\"==\"a6\") &16)\
//          |((\"%1\"==\"a7\") &17)\
//          |((\"%1\"==\"s2\") &18)\
//          |((\"%1\"==\"s3\") &19)\
//          |((\"%1\"==\"s4\") &20)\
//          |((\"%1\"==\"s5\") &21)\
//          |((\"%1\"==\"s6\") &22)\
//          |((\"%1\"==\"s7\") &23)\
//          |((\"%1\"==\"s8\") &24)\
//          |((\"%1\"==\"s9\") &25)\
//          |((\"%1\"==\"s10\")&26)\
//          |((\"%1\"==\"s11\")&27)\
//          |((\"%1\"==\"t3\") &28)\
//          |((\"%1\"==\"t4\") &29)\
//          |((\"%1\"==\"t5\") &30)\
//          |((\"%1\"==\"t6\") &31))) << " _XSTR(OPCODE_RS2_SHIFT_VAL) ")\
//     ") | ("\
//          (( ((\"%2\"==\"t0\") &5)\
//          |((\"%2\"==\"t1\") &6)\
//          |((\"%2\"==\"t2\") &7)\
//          |((\"%2\"==\"s0\") &8)\
//          |((\"%2\"==\"s1\") &9)\
//          |((\"%2\"==\"a0\") &10)\
//          |((\"%2\"==\"a1\") &11)\
//          |((\"%2\"==\"a2\") &12)\
//          |((\"%2\"==\"a3\") &13)\
//          |((\"%2\"==\"a4\") &14)\
//          |((\"%2\"==\"a5\") &15)\
//          |((\"%2\"==\"a6\") &16)\
//          |((\"%2\"==\"a7\") &17)\
//          |((\"%2\"==\"s2\") &18)\
//          |((\"%2\"==\"s3\") &19)\
//          |((\"%2\"==\"s4\") &20)\
//          |((\"%2\"==\"s5\") &21)\
//          |((\"%2\"==\"s6\") &22)\
//          |((\"%2\"==\"s7\") &23)\
//          |((\"%2\"==\"s8\") &24)\
//          |((\"%2\"==\"s9\") &25)\
//          |((\"%2\"==\"s10\")&26)\
//          |((\"%2\"==\"s11\")&27)\
//          |((\"%2\"==\"t3\") &28)\
//          |((\"%2\"==\"t4\") &29)\
//          |((\"%2\"==\"t5\") &30)\
//          |((\"%2\"==\"t6\") &31))) << " _XSTR(OPCODE_DS_SHIFT_VAL) ")\
//     ") | 0x0b))" : "=r"(rd) : "r"(rs1), "r"(rs2) )

unsigned volatile * const p_finisher = (unsigned *) (FINISHER_BASE + 8);

#define PERIAADD(rd, rs1, rs2) __asm__ volatile (".word ((" _XSTR(%1) " << " _XSTR(15) ") | (" _XSTR(%2) " << " _XSTR(20) ") | (" _XSTR(%0) " << " _XSTR(7) ") | 0x0b)" : "=r"(rd) : "r"(rs1),"r"(rs2))
#define PERIVADD(vd, vs1, vs2) __asm__ volatile (".word ((" _XSTR(vs1) " << " _XSTR(15) ") | (" _XSTR(vs2) " << " _XSTR(20) ") | (" _XSTR(vd) " << " _XSTR(7) ") | 0x2b)" : : : "memory")



// #define PERIAADD(rd, rs1, rs2) __asm__ volatile (".word ((" _XSTR(rs1) " << " _XSTR(OPCODE_RS1_SHIFT_VAL) ") | (" _XSTR(rs2) " << " _XSTR(OPCODE_RS2_SHIFT_VAL) ") | (" _XSTR(rd) " << " _XSTR(OPCODE_DS_SHIFT_VAL) ") | CUSTOM0)" : : : "memory")
// unsigned volatile * const p_finisher = (unsigned *) (FINISHER_BASE + 8);

// #define PERIVADD(vd, vs1, vs2) __asm__ volatile (".word ((" _XSTR(vs1) " << " _XSTR(OPCODE_RS1_SHIFT_VAL) ") | (" _XSTR(vs2) " << " _XSTR(OPCODE_RS2_SHIFT_VAL) ") | (" _XSTR(vd) " << " _XSTR(OPCODE_DS_SHIFT_VAL) ") | CUSTOM1)" : : : "memory")



// Triggering XPERIA and XPERIV
int main () { 
    const int a = 10;
    const int b = 11 ;
    int c = 12;

    PERIAADD(10, 11, 12);  // x10 = x11 + x12
    
    __asm__("\
      li      t0, 0x600;\
      csrs    mstatus, t0;\
    \
      li      t0, 1024;\
      vsetvli t0, t0, e32, m2, tu, mu;\
    \
      li      t0, 0x80001000;\
      vle32.v v0, (t0);\
    \
      li      t2, 0x80001100;\
      vle32.v v2, (t2);\
    ");
    
    PERIVADD(4, 0, 2);     // v4 = v0 + v2
    
    *p_finisher = 0x5555;
    while(1) {
        __asm__("nop; nop;");
    };
    return 0;
}
